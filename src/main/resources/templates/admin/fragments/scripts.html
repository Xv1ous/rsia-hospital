<!-- Scripts Fragment -->
<div th:fragment="fragment">
  <script src="/js/admin.js"></script>
  <script th:inline="javascript">
    // Pass doctor schedules data from Thymeleaf to JavaScript
    window.doctorSchedulesData = /*[[${allDoctorSchedules}]]*/ [];
    console.log("Thymeleaf schedules data:", window.doctorSchedulesData);
  </script>
  <script>
    // Doctor Schedule Modal functionality
    const scheduleModal = document.getElementById("doctor-schedule-modal");
    const scheduleModalTitle = document.getElementById("schedule-modal-title");
    const scheduleModalSubtitle = document.getElementById(
      "schedule-modal-subtitle"
    );
    const doctorInitial = document.getElementById("doctor-initial");
    const doctorName = document.getElementById("doctor-name");
    const doctorSpecialization = document.getElementById(
      "doctor-specialization"
    );
    const scheduleTableBody = document.getElementById("schedule-table-body");
    const scheduleFormContainer = document.getElementById(
      "schedule-form-container"
    );
    const scheduleForm = document.getElementById("schedule-form");
    const formTitle = document.getElementById("form-title");
    const addScheduleBtn = document.getElementById("add-schedule-btn");
    const cancelScheduleBtn = document.getElementById("cancel-schedule-btn");
    const closeScheduleModal = document.getElementById("close-schedule-modal");

    // Open schedule modal
    document.querySelectorAll(".schedule-modal-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const doctorId = btn.getAttribute("data-doctor-id");
        const doctorNameValue = btn.getAttribute("data-doctor-name");
        const doctorSpecializationValue = btn.getAttribute(
          "data-doctor-specialization"
        );

        // Update modal content
        scheduleModalTitle.textContent = `Jadwal ${doctorNameValue}`;
        scheduleModalSubtitle.textContent = `Kelola jadwal praktik untuk ${doctorNameValue}`;
        doctorInitial.textContent = doctorNameValue.charAt(0).toUpperCase();
        doctorName.textContent = doctorNameValue;
        doctorSpecialization.textContent = doctorSpecializationValue;
        document.getElementById("doctor-name-input").value = doctorNameValue;
        document.getElementById("specialization").value = doctorSpecializationValue;

        // Load schedules for this doctor
        loadDoctorSchedules(doctorNameValue);

        // Show modal
        scheduleModal.classList.remove("hidden");
      });
    });

    // Close schedule modal
    function closeScheduleModalFunc() {
      scheduleModal.classList.add("hidden");
      scheduleFormContainer.classList.add("hidden");
      scheduleForm.reset();
    }

    closeScheduleModal.addEventListener("click", closeScheduleModalFunc);
    cancelScheduleBtn.addEventListener("click", closeScheduleModalFunc);

    // Close modal when clicking outside
    scheduleModal.addEventListener("click", (e) => {
      if (e.target === scheduleModal) {
        closeScheduleModalFunc();
      }
    });

    // Load doctor schedules
    function loadDoctorSchedules(doctorName) {
      console.log("Loading schedules for doctor:", doctorName);
      console.log("Available schedules data:", window.doctorSchedulesData);

      // Try to get schedules from Thymeleaf data
      if (
        typeof window.doctorSchedulesData !== "undefined" &&
        window.doctorSchedulesData.length > 0
      ) {
        const doctorSchedules = window.doctorSchedulesData.filter(
          (schedule) => schedule.name === doctorName
        );
        console.log("Found schedules for doctor:", doctorSchedules);
        displaySchedules(doctorSchedules);
      } else {
        // If no schedules data, try to fetch from API
        console.log("No schedules data available, trying to fetch from API...");
        fetch(
          `/admin/api/doctor-schedules/search?doctorName=${encodeURIComponent(
            doctorName
          )}`
        )
          .then((response) => response.json())
          .then((data) => {
            console.log("API response:", data);
            displaySchedules(data);
          })
          .catch((error) => {
            console.error("Error fetching schedules:", error);
            displaySchedules([]);
          });
      }
    }

    // Display schedules in table
    function displaySchedules(schedules) {
      console.log("Displaying schedules:", schedules);

      if (!schedules || schedules.length === 0) {
        scheduleTableBody.innerHTML = `
        <tr>
          <td colspan="5" class="py-8 px-6 text-center text-gray-500">
            <div class="flex flex-col items-center">
              <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p class="text-lg font-medium">Belum ada jadwal praktik</p>
              <p class="text-sm">Klik "Tambah Jadwal" untuk menambahkan jadwal praktik</p>
            </div>
          </td>
        </tr>
      `;
      } else {
        scheduleTableBody.innerHTML = schedules
          .map(
            (schedule) => `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="py-3 px-6">
            <div class="flex items-center">
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
              </div>
              <span class="font-medium text-gray-900">${
                schedule.hospital || "N/A"
              }</span>
            </div>
          </td>
          <td class="py-3 px-6">
            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">${
              schedule.day || "N/A"
            }</span>
          </td>
          <td class="py-3 px-6">
            <span class="font-medium text-gray-900">${
              schedule.time || "N/A"
            }</span>
          </td>
          <td class="py-3 px-6">
            <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">${
              schedule.specialization || "N/A"
            }</span>
          </td>
          <td class="py-3 px-6">
            <div class="flex items-center space-x-2">
              <button class="edit-schedule-btn inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors"
                      data-id="${schedule.id || ""}" data-hospital="${
              schedule.hospital || ""
            }" data-day="${schedule.day || ""}" data-time="${
              schedule.time || ""
            }" data-specialization="${schedule.specialization || ""}">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit
              </button>
              <button class="delete-schedule-btn inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium bg-red-100 text-red-700 hover:bg-red-200 transition-colors"
                      data-id="${schedule.id || ""}">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Hapus
              </button>
            </div>
          </td>
        </tr>
      `
          )
          .join("");
      }
    }

    // Add schedule button
    addScheduleBtn.addEventListener("click", () => {
      formTitle.textContent = "Tambah Jadwal Praktik";
      scheduleForm.reset();
      document.getElementById("schedule-id").value = "";
      // Ensure doctor name is set for new schedules
      const currentDoctorName = doctorName.textContent;
      document.getElementById("doctor-name-input").value = currentDoctorName;
      scheduleFormContainer.classList.remove("hidden");
    });

    // Cancel schedule form
    cancelScheduleBtn.addEventListener("click", () => {
      scheduleFormContainer.classList.add("hidden");
      scheduleForm.reset();
    });

    // Schedule form submission
    scheduleForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData(scheduleForm);
      const data = Object.fromEntries(formData);

            console.log("Schedule data:", data);

      const scheduleId = data.id;
      const isEdit = scheduleId && scheduleId.trim() !== '';

      console.log("Is edit mode:", isEdit);
      console.log("Schedule ID:", scheduleId);

      const url = isEdit ? `/admin/api/doctor-schedules/${scheduleId}` : '/admin/api/doctor-schedules';
      const method = isEdit ? 'PUT' : 'POST';

      console.log("API URL:", url);
      console.log("Method:", method);

            fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      })
      .then(res => {
        console.log("API response status:", res.status);
        if (res.ok) {
          console.log("Schedule saved successfully");
          // Close form and reload schedules
          scheduleFormContainer.classList.add("hidden");
          scheduleForm.reset();

          // Reload schedules
          const currentDoctorName = doctorName.textContent;
          loadDoctorSchedules(currentDoctorName);
        } else {
          console.error("API error:", res.status, res.statusText);
          res.text().then(text => {
            console.error("Error response:", text);
            alert(isEdit ? 'Gagal update jadwal' : 'Gagal menambah jadwal');
          });
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error: ' + err);
      });
    });

    // Edit schedule functionality (delegated event)
    scheduleTableBody.addEventListener("click", (e) => {
      if (e.target.closest(".edit-schedule-btn")) {
        const btn = e.target.closest(".edit-schedule-btn");
        formTitle.textContent = "Edit Jadwal Praktik";

        document.getElementById("schedule-id").value =
          btn.getAttribute("data-id");
        document.getElementById("hospital").value =
          btn.getAttribute("data-hospital");
        document.getElementById("day").value = btn.getAttribute("data-day");
        document.getElementById("time").value = btn.getAttribute("data-time");
        document.getElementById("specialization").value = btn.getAttribute(
          "data-specialization"
        );

        // Ensure doctor name is set for edit
        const currentDoctorName = doctorName.textContent;
        document.getElementById("doctor-name-input").value = currentDoctorName;

        scheduleFormContainer.classList.remove("hidden");
      }

      if (e.target.closest(".delete-schedule-btn")) {
        const btn = e.target.closest(".delete-schedule-btn");
        if (confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
          const id = btn.getAttribute("data-id");
          console.log("Delete schedule with ID:", id);

                    fetch(`/admin/api/doctor-schedules/${id}`, {
            method: 'DELETE',
          })
          .then(res => {
            console.log("Delete API response status:", res.status);
            if (res.ok) {
              console.log("Schedule deleted successfully");
              // Remove the row from the table
              btn.closest("tr").remove();

              // Reload schedules to update the display
              const currentDoctorName = doctorName.textContent;
              loadDoctorSchedules(currentDoctorName);
            } else {
              console.error("Delete API error:", res.status, res.statusText);
              res.text().then(text => {
                console.error("Delete error response:", text);
                alert('Gagal menghapus jadwal');
              });
            }
          })
          .catch(err => {
            console.error('Error:', err);
            alert('Error: ' + err);
          });
        }
      }
  });
</script>
</div>
</div>

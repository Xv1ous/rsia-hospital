<!-- Doctor Schedule Section Fragment -->
<section
  th:fragment="schedule"
  x-data="{ selectedSpec: 'semua' }"
  class="w-full py-8 sm:py-12 flex flex-col items-center px-4 max-w-6xl mx-auto mb-8 sm:mb-12"
>
  <h2
    class="text-2xl sm:text-3xl md:text-4xl font-bold text-[#FF8C00] mb-2 text-center"
  >
    Jadwal Dokter
  </h2>
  <p
    class="text-base sm:text-lg text-[#E6521F] mb-6 sm:mb-8 font-medium text-center px-4"
  >
    Temukan Jadwal Praktik Dokter di Rumah Sakit Kami. Gunakan filter di bawah
    untuk mencari dokter atau spesialisasi.
  </p>

  <!-- Filter Tabs - Mobile Optimized -->
  <div class="w-full mb-4">
    <div
      class="flex gap-2 justify-start md:justify-center px-2 overflow-x-auto pb-2 scrollbar-hide"
    >
      <button
        type="button"
        class="specialty-tab flex-shrink-0 px-4 py-2 rounded-full font-medium text-[#E6521F] bg-white shadow text-sm border-2 transition-all duration-200"
        :class="selectedSpec === 'semua' ? 'border-[#FF8C00] bg-[#FF8C00] text-white' : 'border-gray-200 hover:border-[#FF8C00]'"
        @click="selectedSpec = 'semua'"
      >
        Semua
      </button>
      <button
        th:each="spec : ${specializations}"
        type="button"
        class="specialty-tab flex-shrink-0 px-4 py-2 rounded-full font-medium text-[#E6521F] bg-white shadow text-sm border-2 transition-all duration-200"
        th:attr="data-spec=${spec}"
        th:text="${spec}"
        :class="selectedSpec === $el.dataset.spec ? 'border-[#FF8C00] bg-[#FF8C00] text-white' : 'border-gray-200 hover:border-[#FF8C00]'"
        @click="selectedSpec = $el.dataset.spec"
      ></button>
    </div>
  </div>

  <!-- Search Bar - Mobile Optimized -->
  <div class="w-full mb-6 flex flex-col sm:flex-row gap-3 items-center">
    <div class="relative w-full">
      <svg
        class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        ></path>
      </svg>
      <input
        id="doctor-search"
        type="text"
        placeholder="Cari dokter, spesialisasi, atau hari..."
        class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#FF8C00] focus:outline-none text-sm bg-white shadow-sm"
      />
    </div>
    <button
      id="clear-filters"
      type="button"
      class="w-full sm:w-auto px-6 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition text-sm flex items-center justify-center gap-2"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"
        ></path>
      </svg>
      Reset
    </button>
  </div>

  <!-- Desktop Table View -->
  <div
    class="w-full max-w-6xl mx-auto overflow-visible rounded-2xl shadow-lg bg-white p-4 sm:p-6 hidden md:block"
  >
    <div class="overflow-x-auto">
      <table
        class="min-w-full rounded-xl border border-gray-200 text-sm sm:text-base"
        id="doctor-schedule-table-desktop"
      >
        <thead>
          <tr class="bg-[#FF8C00] text-white text-sm sm:text-base">
            <th class="py-3 sm:py-4 px-2 sm:px-4 text-left">Nama Dokter</th>
            <th class="py-3 sm:py-4 px-2 sm:px-4 text-left">Spesialisasi</th>
            <th class="py-3 sm:py-4 px-2 sm:px-4 text-left">Jadwal Praktik</th>
            <th class="py-3 sm:py-4 px-2 sm:px-4 text-left">Profil</th>
          </tr>
        </thead>
        <tbody>
          <tr
            th:each="doctor : ${doctors}"
            class="group border-b hover:bg-[#FFF6E9] transition"
            th:attr="data-spec=${doctor.specialization}"
          >
            <td
              class="py-3 sm:py-4 px-2 sm:px-4 font-extrabold text-base sm:text-lg text-[#FF8C00]"
              th:text="${doctor.name}"
            ></td>
            <td class="py-3 sm:py-4 px-2 sm:px-4">
              <span
                th:text="${doctor.specialization}"
                class="text-sm sm:text-base"
              ></span>
            </td>
            <td class="relative py-3 sm:py-4 px-2 sm:px-4">
              <div class="inline-block">
                <button
                  class="popover-btn px-3 sm:px-4 py-1 rounded-full bg-[#FF8C00] text-white font-semibold shadow hover:bg-[#E6521F] transition text-xs"
                >
                  Lihat Jadwal
                </button>
                <div
                  class="popover-content hidden absolute left-1/2 -translate-x-1/2 top-full mt-2 z-50 bg-white border border-[#FF8C00] rounded-xl shadow-xl p-3 sm:p-4 w-64 sm:w-72"
                >
                  <div
                    class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-l border-t border-[#FF8C00] rotate-45"
                  ></div>
                  <button
                    class="absolute top-2 right-2 text-gray-400 hover:text-[#E6521F] text-lg font-bold close-popover"
                  >
                    &times;
                  </button>
                  <h3
                    class="text-sm sm:text-base font-bold text-[#FF8C00] mb-3 text-center"
                    th:text="${doctor.name}"
                  ></h3>
                  <ul class="space-y-2">
                    <!-- Fallback if no schedules -->
                    <li
                      th:if="${scheduleMap == null or scheduleMap[doctor.name] == null or #lists.size(scheduleMap[doctor.name]) == 0}"
                      class="text-center py-2"
                    >
                      <span class="text-gray-500 text-sm"
                        >Belum ada jadwal tersedia</span
                      >
                    </li>

                    <!-- Actual schedule display -->
                    <li
                      th:if="${scheduleMap != null and scheduleMap[doctor.name] != null and #lists.size(scheduleMap[doctor.name]) > 0}"
                      th:each="jadwal : ${scheduleMap[doctor.name]}"
                      class="flex items-center gap-2 text-sm sm:text-base"
                    >
                      <span
                        class="font-semibold text-[#E6521F]"
                        th:text="${jadwal.day}"
                      ></span
                      >:
                      <span
                        class="text-gray-700"
                        th:text="${jadwal.time}"
                      ></span>
                    </li>
                  </ul>
                </div>
              </div>
            </td>
            <td class="py-3 sm:py-4 px-2 sm:px-4 text-center">
              <a
                th:href="@{'/doctor-profile/' + ${doctor.id}}"
                class="inline-block px-2 py-1 rounded-full bg-[#E6521F] text-white font-semibold hover:bg-[#FB9E3A] hover:text-[#E6521F] transition text-xs min-w-[70px] text-center whitespace-nowrap"
              >
                Profil
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mobile Card View - Enhanced -->
  <div
    class="w-full max-w-6xl mx-auto space-y-4 md:hidden"
    id="doctor-schedule-cards-mobile"
  >
    <div
      th:each="doctor : ${doctors}"
      class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden transition-all duration-200 hover:shadow-xl"
      th:attr="data-spec=${doctor.specialization}"
    >
      <!-- Doctor Header with Avatar -->
      <div class="p-4 border-b border-gray-50">
        <div class="flex items-center gap-3">
          <div class="flex-1 min-w-0">
            <h3
              class="font-bold text-lg text-gray-900 mb-1 truncate"
              th:text="${doctor.name}"
            ></h3>
            <div class="flex items-center gap-2">
              <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800"
                th:text="${doctor.specialization}"
              ></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule Preview -->
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-800 flex items-center gap-2">
            <svg
              class="w-4 h-4 text-[#FF8C00]"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
            Jadwal Praktik
          </h4>
          <span
            class="text-xs text-gray-500"
            th:if="${scheduleMap != null and scheduleMap[doctor.name] != null}"
            th:text="${#lists.size(scheduleMap[doctor.name])} + ' hari'"
          ></span>
          <span
            class="text-xs text-gray-500"
            th:if="${scheduleMap == null or scheduleMap[doctor.name] == null or #lists.size(scheduleMap[doctor.name]) == 0}"
            >0 hari</span
          >
        </div>

        <!-- Quick Schedule Preview -->
        <div class="flex flex-wrap gap-2 mb-4">
          <!-- Jadwal tersedia -->
          <div
            th:if="${scheduleMap != null and scheduleMap[doctor.name] != null and iterStat.index < 3}"
            th:each="jadwal, iterStat : ${scheduleMap[doctor.name]}"
            class="flex items-center gap-1.5 px-2 py-1 bg-orange-50 rounded-lg border border-orange-100"
          >
            <div class="w-2 h-2 bg-[#FF8C00] rounded-full"></div>
            <span
              class="text-xs font-medium text-[#E6521F]"
              th:text="${#strings.substring(jadwal.day, 0, 3)}"
            ></span>
            <span class="text-xs text-gray-600" th:text="${jadwal.time}"></span>
          </div>

          <!-- Indikator jadwal lebih dari 3 -->
          <div
            th:if="${scheduleMap != null and scheduleMap[doctor.name] != null and #lists.size(scheduleMap[doctor.name]) > 3}"
            class="flex items-center gap-1.5 px-2 py-1 bg-gray-100 rounded-lg border border-gray-300"
          >
            <span class="text-xs text-gray-600">
              +<span
                th:text="${#lists.size(scheduleMap[doctor.name]) - 3}"
              ></span>
              lagi
            </span>
          </div>

          <!-- Fallback: Tidak ada jadwal -->
          <div
            th:unless="${scheduleMap != null and scheduleMap[doctor.name] != null and !scheduleMap[doctor.name].isEmpty()}"
            class="flex items-center gap-1.5 px-2 py-1 bg-gray-100 rounded-lg border border-gray-300"
          >
            <span class="text-xs text-gray-500">Jadwal belum tersedia</span>
          </div>
        </div>

        <!-- View Full Schedule Button -->
        <button
          class="w-full popover-btn-mobile px-4 py-3 rounded-xl bg-[#E6521F] text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-2 group"
        >
          <svg
            class="w-4 h-4 group-hover:scale-110 transition-transform"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            ></path>
          </svg>
          Lihat Jadwal Lengkap
        </button>

        <!-- Mobile Schedule Modal - Enhanced -->
        <div
          class="mobile-schedule-modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
        >
          <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-sm max-h-[85vh] overflow-hidden"
          >
            <!-- Modal Content -->
            <div class="p-4">
              <div class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto">
                <!-- Fallback if no schedules -->
                <div
                  th:if="${scheduleMap == null or scheduleMap[doctor.name] == null or #lists.size(scheduleMap[doctor.name]) == 0}"
                  class="text-center py-8"
                >
                  <p class="text-gray-500">Belum ada jadwal tersedia</p>
                </div>

                <!-- Actual schedule display -->
                <div
                  th:if="${scheduleMap != null and scheduleMap[doctor.name] != null and #lists.size(scheduleMap[doctor.name]) > 0}"
                  th:each="jadwal : ${scheduleMap[doctor.name]}"
                  class="flex items-center justify-between p-4 bg-gradient-to-r from-orange-50 to-red-50 rounded-xl border border-orange-100 hover:shadow-md transition-all duration-200"
                >
                  <div class="flex items-center gap-3">
                    <div>
                      <span
                        class="font-bold text-[#E6521F] text-base block"
                        th:text="${jadwal.day}"
                      ></span>
                      <span class="text-xs text-gray-500">Jadwal Praktik</span>
                    </div>
                  </div>
                  <div class="text-right">
                    <span class="text-xs" th:text="${jadwal.time}"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal Footer -->
            <div
              class="sticky bottom-0 bg-gray-50 p-4 border-t border-gray-200"
            >
              <div class="flex gap-3">
                <a
                  th:href="@{'/doctor-profile/' + ${doctor.id}}"
                  class="flex-1 py-3 bg-[#E6521F] text-white font-semibold rounded-xl hover:bg-[#FB9E3A] transition text-center flex items-center justify-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                    ></path>
                  </svg>
                  Lihat Profil
                </a>
                <button
                  class="flex-1 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition close-mobile-modal"
                >
                  Tutup
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div
    id="pagination-controls"
    class="w-full flex justify-center mt-8 mb-4 px-4 pt-4"
  ></div>

  <style>
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const specialtyTabs = document.querySelectorAll(".specialty-tab");
      const searchInput = document.getElementById("doctor-search");
      const clearBtn = document.getElementById("clear-filters");
      const desktopTable = document.getElementById(
        "doctor-schedule-table-desktop"
      );
      const mobileCards = document.getElementById(
        "doctor-schedule-cards-mobile"
      );
      let selectedSpecialty = "semua";
      const MAX_ITEMS_TO_SHOW = 5;
      let currentPage = 1;
      const itemsPerPage = MAX_ITEMS_TO_SHOW;

      // Filter spesialisasi
      specialtyTabs.forEach((tab) => {
        tab.addEventListener("click", function () {
          specialtyTabs.forEach((t) =>
            t.classList.remove("border-[#FF8C00]", "bg-[#FF8C00]", "text-white")
          );
          specialtyTabs.forEach((t) =>
            t.classList.add("border-gray-200", "text-[#E6521F]")
          );
          this.classList.remove("border-gray-200", "text-[#E6521F]");
          this.classList.add("border-[#FF8C00]", "bg-[#FF8C00]", "text-white");
          selectedSpecialty = this.getAttribute("data-spec") || "semua";
          currentPage = 1;
          filterItems();
        });
      });

      // Search functionality
      let searchTimeout;
      searchInput.addEventListener("input", function () {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentPage = 1;
          filterItems();
        }, 300);
      });

      // Clear filters
      clearBtn.addEventListener("click", function () {
        searchInput.value = "";
        selectedSpecialty = "semua";
        currentPage = 1;
        specialtyTabs.forEach((t) =>
          t.classList.remove("border-[#FF8C00]", "bg-[#FF8C00]", "text-white")
        );
        specialtyTabs.forEach((t) =>
          t.classList.add("border-gray-200", "text-[#E6521F]")
        );
        document
          .querySelector('[data-spec="semua"]')
          .classList.remove("border-gray-200", "text-[#E6521F]");
        document
          .querySelector('[data-spec="semua"]')
          .classList.add("border-[#FF8C00]", "bg-[#FF8C00]", "text-white");
        filterItems();
      });

      function filterItems() {
        const isMobile = window.innerWidth < 768;
        const container = isMobile ? mobileCards : desktopTable;

        if (isMobile) {
          const cards = container.querySelectorAll("div[data-spec]");
          const searchTerm = searchInput.value.toLowerCase();
          let visibleCards = [];

          cards.forEach((card) => {
            const spec = card.getAttribute("data-spec");
            const text = card.textContent.toLowerCase();
            const specMatch =
              selectedSpecialty === "semua" || spec === selectedSpecialty;
            const searchMatch = text.includes(searchTerm);
            if (specMatch && searchMatch) visibleCards.push(card);
          });

          cards.forEach((card) => (card.style.display = "none"));

          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const cardsToShow = visibleCards.slice(startIndex, endIndex);

          cardsToShow.forEach((card) => (card.style.display = "block"));
          updatePaginationInfo(visibleCards.length);
        } else {
          const rows = container.querySelectorAll("tbody tr");
          const searchTerm = searchInput.value.toLowerCase();
          let visibleRows = [];

          rows.forEach((row) => {
            const spec = row.getAttribute("data-spec");
            const text = row.textContent.toLowerCase();
            const specMatch =
              selectedSpecialty === "semua" || spec === selectedSpecialty;
            const searchMatch = text.includes(searchTerm);
            if (specMatch && searchMatch) visibleRows.push(row);
          });

          rows.forEach((row) => (row.style.display = "none"));

          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const rowsToShow = visibleRows.slice(startIndex, endIndex);

          rowsToShow.forEach((row) => (row.style.display = ""));
          updatePaginationInfo(visibleRows.length);
        }
      }

      function updatePaginationInfo(totalVisibleRows) {
        const totalPages = Math.ceil(totalVisibleRows / itemsPerPage);
        const paginationContainer = document.getElementById(
          "pagination-controls"
        );

        paginationContainer.innerHTML = "";

        // Always show pagination container for debugging
        paginationContainer.style.display = "flex";

        if (totalPages <= 1) {
          paginationContainer.style.display = "none";
          return;
        }
        const paginationDiv = document.createElement("div");
        paginationDiv.className =
          "flex justify-center items-center gap-2 w-full flex-wrap";
        paginationDiv.innerHTML = `
          <button id="prev-page" class="px-2 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-xs flex items-center gap-1 min-w-fit">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="hidden sm:inline">Sebelumnya</span>
          </button>
          <span id="page-info" class="text-gray-600 font-medium text-xs px-2 py-2 text-center min-w-fit">${currentPage}/${totalPages}</span>
          <button id="next-page" class="px-2 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-xs flex items-center gap-1 min-w-fit">
            <span class="hidden sm:inline">Selanjutnya</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        `;
        paginationContainer.appendChild(paginationDiv);

        // Update button states
        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        document.getElementById("prev-page").addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            filterItems();
          }
        });

        document.getElementById("next-page").addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            filterItems();
          }
        });
      }

      // Desktop popover functionality
      document.querySelectorAll(".popover-btn").forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.stopPropagation();
          document.querySelectorAll(".popover-content").forEach(function (pop) {
            if (pop !== btn.nextElementSibling) pop.classList.add("hidden");
          });
          btn.nextElementSibling.classList.toggle("hidden");
        });
      });

      // Mobile modal functionality
      document.querySelectorAll(".popover-btn-mobile").forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();

          const modal = btn.nextElementSibling;
          const isHidden = modal.classList.contains("hidden");

          // Close all other modals first
          document
            .querySelectorAll(".mobile-schedule-modal")
            .forEach(function (otherModal) {
              if (otherModal !== modal) {
                otherModal.classList.add("hidden");
              }
            });

          // Close all desktop popovers
          document
            .querySelectorAll(".popover-content")
            .forEach(function (popover) {
              popover.classList.add("hidden");
            });

          // Toggle current modal
          if (isHidden) {
            modal.classList.remove("hidden");
            document.body.style.overflow = "hidden";
          } else {
            modal.classList.add("hidden");
            document.body.style.overflow = "auto";
          }
        });
      });

      // Close buttons
      document.querySelectorAll(".close-popover").forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.stopPropagation();
          btn.closest(".popover-content").classList.add("hidden");
        });
      });

      document.querySelectorAll(".close-mobile-modal").forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          const modal = btn.closest(".mobile-schedule-modal");
          modal.classList.add("hidden");
          document.body.style.overflow = "auto";
        });
      });

      // Close all popovers and modals when clicking outside
      document.addEventListener("click", function (e) {
        // Close desktop popovers
        document.querySelectorAll(".popover-content").forEach(function (pop) {
          pop.classList.add("hidden");
        });

        // Close mobile modals when clicking on backdrop
        document
          .querySelectorAll(".mobile-schedule-modal")
          .forEach(function (modal) {
            if (e.target === modal) {
              modal.classList.add("hidden");
              document.body.style.overflow = "auto";
            }
          });
      });

      // Initial filter
      filterItems();

      // Handle window resize
      window.addEventListener("resize", function () {
        currentPage = 1; // Reset to first page on resize
        filterItems();
      });
    });
  </script>
</section>

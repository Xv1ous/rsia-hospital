<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pendaftaran Pasien - RSIA Buah Hati Pamulang</title>
    <link href="/main.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="min-h-screen h-full flex flex-col bg-gray-50 text-gray-900 font-sans"
  >
    <script th:inline="javascript">
      document.title = "Pendaftaran Pasien - RSIA Buah Hati Pamulang";
    </script>

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="flex-1">
      <nav class="max-w-6xl mx-auto px-4 pt-20" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm text-gray-500">
          <li><a href="/" class="hover:underline">Beranda</a></li>
          <li><span class="mx-2">/</span></li>
          <li class="text-[#FB9E3A] font-semibold">Pendaftaran Pasien</li>
        </ol>
      </nav>

      <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h1 class="text-2xl font-bold text-[#E6521F] mb-6 text-center">
            Pendaftaran Pasien Baru
          </h1>

          <!-- Informasi Sistem -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-blue-800 mb-2">
              📋 Informasi Sistem Pembatasan:
            </h3>
            <ul class="text-sm text-blue-700 space-y-1">
              <li>
                • <strong>Cuti:</strong> Dokter yang sedang cuti tidak dapat
                menerima pendaftaran
              </li>
              <li>
                • <strong>Kunci Dobel:</strong> Setiap pasien hanya dapat
                mendaftar 1x per dokter per minggu
              </li>
              <li>
                • <strong>Batasan:</strong> Maksimal 30 pasien per dokter per
                hari
              </li>
            </ul>
          </div>

          <!-- Form Pendaftaran -->
          <form id="registration-form" class="space-y-6">
            <!-- Pilih Dokter -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Pilih Dokter <span class="text-red-500">*</span>
              </label>
              <select
                id="doctor-select"
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#E6521F] focus:border-[#E6521F]"
                required
              >
                <option value="">Pilih dokter...</option>
              </select>
              <div id="doctor-status" class="mt-2 text-sm"></div>
            </div>

            <!-- Pilih Tanggal -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Tanggal Janji Temu <span class="text-red-500">*</span>
              </label>
              <input
                type="date"
                id="appointment-date"
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#E6521F] focus:border-[#E6521F]"
                required
              />
              <div id="date-status" class="mt-2 text-sm"></div>
            </div>

            <!-- Pilih Waktu -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Waktu Janji Temu <span class="text-red-500">*</span>
              </label>
              <select
                id="appointment-time"
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#E6521F] focus:border-[#E6521F]"
                required
              >
                <option value="">Pilih waktu...</option>
                <option value="08:00">08:00</option>
                <option value="09:00">09:00</option>
                <option value="10:00">10:00</option>
                <option value="11:00">11:00</option>
                <option value="13:00">13:00</option>
                <option value="14:00">14:00</option>
                <option value="15:00">15:00</option>
                <option value="16:00">16:00</option>
              </select>
            </div>

            <!-- Data Pasien -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Nama Lengkap <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="patient-name"
                  class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#E6521F] focus:border-[#E6521F]"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Nomor Telepon <span class="text-red-500">*</span>
                </label>
                <input
                  type="tel"
                  id="patient-phone"
                  class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#E6521F] focus:border-[#E6521F]"
                  required
                />
              </div>
            </div>

            <!-- Catatan -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Catatan (Opsional)
              </label>
              <textarea
                id="notes"
                rows="3"
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#E6521F] focus:border-[#E6521F]"
                placeholder="Keluhan atau informasi tambahan..."
              ></textarea>
            </div>

            <!-- Tombol Submit -->
            <div class="flex justify-center">
              <button
                type="submit"
                class="bg-[#E6521F] text-white py-3 px-8 rounded-md hover:bg-[#FF8000] transition duration-200 font-semibold"
              >
                Daftar Sekarang
              </button>
            </div>
          </form>

          <!-- Modal Hasil -->
          <div
            id="result-modal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
          >
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
              <div id="result-content"></div>
              <div class="mt-4 flex justify-center">
                <button
                  onclick="closeModal()"
                  class="bg-[#E6521F] text-white py-2 px-4 rounded-md hover:bg-[#FF8000]"
                >
                  Tutup
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script>
      let doctors = [];

      // Load doctors
      async function loadDoctors() {
        try {
          const response = await fetch("/admin/api/doctors");
          doctors = await response.json();

          const select = document.getElementById("doctor-select");
          select.innerHTML = '<option value="">Pilih dokter...</option>';

          doctors.forEach((doctor) => {
            const option = document.createElement("option");
            option.value = doctor.id;
            option.textContent = `${doctor.name} - ${doctor.specialization}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading doctors:", error);
        }
      }

      // Check doctor status
      async function checkDoctorStatus() {
        const doctorId = document.getElementById("doctor-select").value;
        const date = document.getElementById("appointment-date").value;

        if (!doctorId || !date) return;

        try {
          const response = await fetch(
            `/api/registration/doctor-status?doctorId=${doctorId}&date=${date}`
          );
          const status = await response.json();

          const statusDiv = document.getElementById("doctor-status");
          const dateStatusDiv = document.getElementById("date-status");

          let statusClass = "text-green-600";
          let statusIcon = "✅";

          if (status.status === "ON_LEAVE") {
            statusClass = "text-red-600";
            statusIcon = "🚫";
          } else if (status.status === "LOCKED") {
            statusClass = "text-yellow-600";
            statusIcon = "🔒";
          } else if (status.status === "FULL") {
            statusClass = "text-red-600";
            statusIcon = "🈵";
          }

          statusDiv.innerHTML = `<span class="${statusClass}">${statusIcon} ${status.message}</span>`;
          dateStatusDiv.innerHTML = `<span class="${statusClass}">Kapasitas: ${
            status.usedSlots || 0
          }/${status.totalSlots || 30}</span>`;
        } catch (error) {
          console.error("Error checking doctor status:", error);
        }
      }

      // Validate registration
      async function validateRegistration() {
        const doctorId = document.getElementById("doctor-select").value;
        const patientPhone = document.getElementById("patient-phone").value;
        const appointmentDate =
          document.getElementById("appointment-date").value;

        if (!doctorId || !patientPhone || !appointmentDate) return true;

        try {
          const response = await fetch("/api/registration/validate", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `doctorId=${doctorId}&patientPhone=${patientPhone}&appointmentDate=${appointmentDate}`,
          });

          const result = await response.json();
          return result.valid;
        } catch (error) {
          console.error("Error validating registration:", error);
          return true;
        }
      }

      // Submit form
      async function submitRegistration(formData) {
        try {
          const response = await fetch("/api/registration/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: formData,
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("Error submitting registration:", error);
          return { success: false, message: "Terjadi kesalahan sistem" };
        }
      }

      // Show modal
      function showModal(content, isSuccess = true) {
        const modal = document.getElementById("result-modal");
        const contentDiv = document.getElementById("result-content");

        const icon = isSuccess ? "✅" : "❌";
        const color = isSuccess ? "text-green-600" : "text-red-600";

        contentDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl mb-4">${icon}</div>
                    <h3 class="text-lg font-semibold ${color} mb-2">${
          isSuccess ? "Pendaftaran Berhasil!" : "Pendaftaran Gagal"
        }</h3>
                    <p class="text-gray-700">${content}</p>
                </div>
            `;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      // Close modal
      function closeModal() {
        const modal = document.getElementById("result-modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");

        // Reset form if successful
        document.getElementById("registration-form").reset();
        document.getElementById("doctor-status").innerHTML = "";
        document.getElementById("date-status").innerHTML = "";
      }

      // Event listeners
      document
        .getElementById("doctor-select")
        .addEventListener("change", checkDoctorStatus);
      document
        .getElementById("appointment-date")
        .addEventListener("change", checkDoctorStatus);

      document
        .getElementById("registration-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Validate form
          const form = e.target;
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }

          // Check registration validation
          const isValid = await validateRegistration();
          if (!isValid) {
            showModal(
              "Pendaftaran tidak valid. Silakan cek kembali data Anda.",
              false
            );
            return;
          }

          // Prepare form data
          const formData = new URLSearchParams();
          formData.append(
            "doctorId",
            document.getElementById("doctor-select").value
          );
          formData.append(
            "patientName",
            document.getElementById("patient-name").value
          );
          formData.append(
            "patientPhone",
            document.getElementById("patient-phone").value
          );
          formData.append(
            "appointmentDate",
            document.getElementById("appointment-date").value
          );
          formData.append(
            "registrationTime",
            document.getElementById("appointment-time").value
          );
          formData.append("notes", document.getElementById("notes").value);

          // Submit registration
          const result = await submitRegistration(formData);
          showModal(result.message, result.success);
        });

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadDoctors();

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("appointment-date").min = today;
      });
    </script>
  </body>
</html>
